import os
import pandas as pd
from tqdm import tqdm
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.firefox.options import Options


malwareName = "Ryuk"
try:
    outputDirectory = f"{malwareName}"
    parentDir = "/home/frank/Documents/thesisScripts/MalwareSamples/"
    outputPath = os.path.join(parentDir, outputDirectory)
    os.mkdir(outputPath)
except:
    pass

df = pd.read_csv(parentDir + f'output_{malwareName}.csv')

options = Options()
options.set_preference("browser.download.folderList", 2)
options.set_preference("browser.download.manager.showWhenStarting", False)
options.set_preference("browser.download.dir", f"/home/frank/Documents/thesisScripts/MalwareSamples/{malwareName}")

geckoPath = "/snap/bin/geckodriver"
browserService = webdriver.FirefoxService(executable_path=geckoPath)

browser = webdriver.Firefox(options=options, service=browserService)
for index, row in tqdm(df.iterrows()):
    if row['type'] != 'exe':
        continue
    downloadLink = row['download_link']
    browser.get(downloadLink)
    if browser.current_url == "https://bazaar.abuse.ch/verify-ua/":
        input("Captcha found, manual interaction needed... Press Enter to continue.")
    browser.find_element(By.XPATH, "//main/div/button").click()