import json
import pandas as pd
from selenium import webdriver
from selenium.webdriver.common.by import By
  

path = "/home/frank/Documents/thesisScripts/"

malwareName = "Ryuk"
geckoPath = "/snap/bin/geckodriver"
browserService = webdriver.FirefoxService(executable_path=geckoPath)
browser = webdriver.Firefox(service=browserService)
browser.get("https://bazaar.abuse.ch/browse.php")
if browser.current_url == "https://bazaar.abuse.ch/verify-ua/":
    input("Captcha found, manual interaction needed... Press Enter to continue.")
browser.get(f"https://bazaar.abuse.ch/browse.php?search=signature%3A{malwareName}")

totalEntriesText = browser.find_element(By.XPATH, "//div[@class='dataTables_info']").text
totalEntries = int(totalEntriesText.split()[-2])
totalPages = totalEntries//250 + 1

samples = []
for page in range(totalPages):
    entries = browser.find_elements(By.XPATH, "//tbody/tr[@role='row']")
    for entry in entries:
        sample = {}
        sample['upload_date'] = entry.find_element(By.XPATH, ".//td[1]").text
        sample['sha256_hash'] = entry.find_element(By.XPATH, ".//td[2]/a").accessible_name
        sample['type'] = entry.find_element(By.XPATH, ".//td[3]").accessible_name.split()[-1]
        tags = entry.find_elements(By.XPATH, ".//td[5]/a")
        sample['tags'] = [tag.accessible_name for tag in tags]
        sample['info_link'] = f"https://bazaar.abuse.ch/sample/{sample['sha256_hash']}"
        sample['download_link'] = f"https://bazaar.abuse.ch/download/{sample['sha256_hash']}"
        samples.append(sample)
    if page+1 == totalPages:
        break
    next = browser.find_element(By.XPATH, "//li[@id='samples_next']").find_element(By.XPATH, ".//a").click()

browser.close()
df = pd.read_json(json.dumps(samples))
df.to_csv(f'/home/frank/Documents/thesisScripts/MalwareSamples/output_{malwareName}.csv', encoding='utf-8', index=False)